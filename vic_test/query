PRAGMA foreign_leys=OFF;

BEGIN TRANSACTION;
ALTER TABLE vic RENAME TO vic_old;

CREATE TABLE vic (
	full_path text,
	digest text,
	digest_time real,
	mod_time real,
	file_size int,
	err int,
	err_video int,
	err_audio int,
	err_container int,
	err_text text,
	collisions int,
	collision_videos text
);

DROP INDEX idx_full_path;
DROP INDEX idx_digest;
DROP INDEX idx_pass;
DROP INDEX idx_collisions;
CREATE INDEX idx_full_path ON vic(full_path);
CREATE INDEX idx_digest ON vic(digest);
CREATE INDEX idx_pass ON vic(pass);
CREATE INDEX idx_err_video ON vic(err_video);
CREATE INDEX idx_err_audio ON vic(err_audio);
CREATE INDEX idx_err_container ON vic(err_container);
CREATE INDEX idx_collisions ON vic(collisions);

INSERT INTO vic (full_path,digest,digest_time,mod_time,file_size,err,err_video,err_audio,err_container,err_text,collisions,collision_videos)
	SELECT
		full_path,
		digest,
		NULL as digest_time,
		NULL as mod_time,
		NULL as file_size
		CASE
			WHEN pass = 1
				THEN 0
			ELSE 1
		END err,
		CASE
			WHEN err_text 
				LIKE '%[h264 @ %]%'
				OR err_text LIKE '%[hevc @ %]%'
				OR err_text LIKE '%[mpeg4 @ %]%'
			THEN 1 ELSE 0
		END err_video,
		CASE
			WHEN err_text 
				LIKE '%[mp3float @ %]%'
				OR err_text LIKE '%[aac @ %]%'
				OR err_text LIKE '%[ac3 @ %]%'
				OR err_text LIKE '%[truehd @ %]%'
				OR err_text LIKE '%[flac @ %]%'
			THEN 1 ELSE 0
		END err_audio,
		CASE
			WHEN err_text 
				LIKE '%[matroska,webm @ %]%'
			THEN 1 ELSE 0
		END err_container,
		err_text,
		collisions,
		collision_videos
	FROM vic_old;

DROP TABLE vic_old;

PRAGMA foreign_leys=ON;

COMMIT;